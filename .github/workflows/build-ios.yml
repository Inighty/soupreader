# SoupReader iOS Build Workflow
# æ¯æ¬¡æ¨é€ä»£ç è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆæœªç­¾åçš„IPA

name: Build iOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      # æ˜¾ç¤º Flutter ç‰ˆæœ¬ä¿¡æ¯
      - name: Flutter version
        run: flutter --version

      # è·å–ä¾èµ–
      - name: Get dependencies
        run: flutter pub get

      # åˆ†æä»£ç ï¼ˆä»…è­¦å‘Šä¸é˜»æ­¢æ„å»ºï¼‰
      - name: Analyze code
        run: flutter analyze --no-fatal-infos --no-fatal-warnings
        continue-on-error: true

      # ç¦ç”¨ Xcode ä»£ç ç­¾åï¼ˆCI ç¯å¢ƒå¿…éœ€ï¼‰
      - name: Disable Code Signing
        run: |
          # ä¿®æ”¹ Xcode é¡¹ç›®é…ç½®ä»¥ç¦ç”¨ç­¾å
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' ios/Runner.xcodeproj/project.pbxproj
          # æ·»åŠ å…¨å±€ç¦ç”¨é…ç½®
          echo 'CODE_SIGNING_ALLOWED=NO' >> ios/Flutter/Release.xcconfig
          echo 'CODE_SIGNING_REQUIRED=NO' >> ios/Flutter/Release.xcconfig

      # æ„å»º iOSï¼ˆæ— ç­¾åï¼‰
      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign
          
      # åˆ›å»ºæœªç­¾åçš„ IPA (Releaseéœ€è¦IPAæ–‡ä»¶)
      - name: Create unsigned IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          mkdir Payload
          cp -r Runner.app Payload/
          zip -r ../ipa/SoupReader-unsigned.ipa Payload
          rm -rf Payload

      # å‘å¸ƒåˆ° GitHub Releases
      - name: Deploy to Releases
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: nightly
          commit: ${{ github.sha }}
          name: Nightly Build
          body: |
            ğŸ“¦ æœ€æ–°æ„å»º
            - Commit: ${{ github.sha }}
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - è§¦å‘è€…: ${{ github.actor }}
          artifacts: "build/ios/ipa/SoupReader-unsigned.ipa"
          token: ${{ secrets.GITHUB_TOKEN }}
          removeArtifacts: true
          replacesArtifacts: true
          makeLatest: true
          prerelease: true

      # ä¸Šä¼  App Bundle ä½œä¸º Artifact (å¼€å‘è°ƒè¯•ç”¨)
      - name: Upload .app artifact
        uses: actions/upload-artifact@v4
        with:
          name: Runner.app
          path: build/ios/iphoneos/Runner.app
          retention-days: 3

      # ä¸Šä¼  dSYM æ–‡ä»¶ï¼ˆç”¨äºå´©æºƒåˆ†æï¼‰
      - name: Upload dSYM
        uses: actions/upload-artifact@v4
        with:
          name: SoupReader-iOS-dSYM
          path: build/ios/iphoneos/Runner.app.dSYM
          retention-days: 30
          if-no-files-found: ignore
