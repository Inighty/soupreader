# SoupReader 协作规范（AGENTS）

> 适用范围：`/home/server/soupreader` 全项目。

> 说明：本文件仅保留长期有效的协作规范与执行约束，不承载任务级排期内容。

## 1) 总原则（强约束）

- 所有回复、说明、代码评审意见默认使用中文。
- 书源处理规则语义与功能行为以同级项目 `legado` 为第一标准。
- 全仓库默认采用迁移级别推进，不采用最小收敛口径。
- 默认顺序为核心优先；扩展功能需需求方明确指令后才能启动。

### 1.1 legado 复刻前置规则（强制）

- 所有功能开发在动手前，必须先确认 legado 中对应功能的实现与行为。
- 确认 legado 实现时，相关文件需完整读取后再下结论。
- 复刻以交互语义、状态流转、边界处理同义为准，避免主观改写。
- 无法确认对应实现时，先暂停并与需求方确认。

### 1.1.1 迁移级别定义（强制）

- 适用全仓库（页面、服务、工具层）。
- 除平台 UI 实现差异外，交互路径、状态流转、生命周期、错误处理、菜单触发、用户可见语义必须与 legado 同义。
- 禁止保留会导致行为偏差的扩展入口、扩展流程、扩展文案。

### 1.1.2 迁移例外流程（强制）

- 若 legado 能力暂无法等价复现，必须先暂停并与需求方确认后再继续。
- 例外出现时，先标记 `blocked`，不得继续主流程。
- 例外记录至少包含：原因、影响范围、替代方案、回补计划。
- 未完成确认与记录前，不得宣称一致性迁移完成。

### 1.2 UI 规范（强制）

- 使用 `Flutter Cupertino`（Flutter 自带 Cupertino 组件）。
- 新增/改造 UI 必须以 `Flutter Cupertino` 作为主实现，禁止引入 `Shadcn` 或其它 UI 体系作为主实现。
- 字体统一使用 `San Francisco`（系统 SF 字体族），保持 iOS 视觉一致。
- 弹窗统一使用 iOS 风格弹窗（如 `CupertinoAlertDialog`、`CupertinoActionSheet`）。
- 页面导航必须支持 iOS 滑动返回（侧滑返回）。
- 导航栏优先使用 iOS 大标题导航（`CupertinoSliverNavigationBar` 或同义实现）。
- 若暂无等价能力，需记录原因、范围、替代方案。
- 不符合本规范视为阻塞项。
- 文档：`https://api.flutter.dev/flutter/cupertino/cupertino-library.html`

### 1.2.1 排版布局一致性（强制）

- 页面迁移或 UI 调整时，排版结构、信息层级、间距、对齐需与 legado 语义同义（平台差异除外）。
- 加载、空态、错误、成功等状态下布局规则必须一致。
- 列表、详情、工具栏、弹窗等高频区域需逐项核对热区与排版。
- 暂无法等价时，按 `1.1.2` 先标记 `blocked` 并完成记录。

---

## 3) 测试与验收（提交推送前检查）

- 开发完成后，禁止新增、编写或改造测试用例（含 `test/` 目录下文件与断言），除非需求方明确要求。
- `flutter analyze` 仅在提交推送前执行一次，开发过程中禁止提前执行。
- 中途校验仅使用与改动相关的手工回归路径。
- 迁移级改动需补充对应手工回归验证并记录。

## 5) 任务执行与沟通流程（必须）

- 接到需求后，先拆分为可执行清单，并标注每项的依赖关系与可并行性（串行/并行）。
- 同一需求含核心与扩展时，先完成核心并验收；扩展需需求方明确指令后再启动。
- 迁移级任务的第 1 项必须是差异点清单，未完成前不得启动实现并行分支。
- 允许并行推进，但前置依赖必须串行；并行项需明确 owner，避免同文件无序覆盖。
- UI 事项必须包含排版布局一致性检查并回填结果。
- 执行过程中不要每完成一项就询问是否继续。
- 仅在以下场景可以暂停并询问：
  1. 缺少必要信息，导致无法继续；
  2. 存在明显风险或破坏性操作（如删除、覆盖、付费、生产环境操作等）。
- 并行分支冲突或阻塞时，先标记 `blocked` 并记录处理方案，再推进其他分支。
- 迁移任务未完成逐项对照清单前，结论不得使用“完全一致/已一致”等措辞。
- 全部完成后，回复必须包含：
  - 并行分支完成情况汇总（含未完成/阻塞项）
  - 完成情况汇总
  - 如何验证

---
