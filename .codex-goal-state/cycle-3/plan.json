{"done":false,"done_reason":"当前仓库仍存在 UI 与 AGENTS 规范不一致点：核心页大标题导航仅 N-01 已接入，N-02~N-04 仍未接入；同时 lib/ 下仍有少量 `package:flutter/material.dart` 残留导入（SelectableText、ReorderableListView、CustomPaint 等）。因此目标“根据 AGENTS.md 修改 UI”未完成，需要继续迁移与回归收口。","goal_summary":"按 AGENTS.md 的迁移级口径推进：先冻结差异清单，再并行完成四个核心页（发现/订阅/我的）大标题导航接入，随后清理残留 Material 依赖并回填 N-VAL-01 手工回归证据。","tasks":[{"id":"R3-T01","title":"冻结本轮 UI 差异清单（含 Material 残留）","priority":1,"prompt":"改动范围：仅文档台账，更新 `docs/plans/2026-02-27-ui-cupertino-diff.md`（必要时同步 `PLANS.md` 的状态描述，但不改业务代码）。\n\n预期行为：\n1) 复扫并冻结当前 repo 的差异点：\n- `N-02~N-04` 未接入 `useSliverNavigationBar: true`（发现/订阅/我的三页）。\n- `lib/` 下残留 `package:flutter/material.dart` 导入文件清单（至少包含：`app_help_dialog.dart`、`about_settings_view.dart`、`reader_dict_lookup_sheet.dart`、`scroll_segment_paint_view.dart`、`source_list_view.dart`）。\n2) 在台账中新增“Material 残留清退”条目（可用 `M-01~M-xx` 编号），明确：原因、影响范围、替代方案（改用 `flutter/widgets.dart` 或 Cupertino 等价）、回补计划。\n3) 明确本轮实施依赖链：`N-02/N-03/N-04 -> N-VAL-01`（并标注可并行项与 owner）。\n\n验证方式：\n- 命令复核统计与清单一致；台账中的命中数/文件列表与实际 `rg` 结果一致。","verify_cmd":"cd /home/server/soupreader && rg -n \"useSliverNavigationBar\" lib && rg -n \"package:flutter/material\\\\.dart\" lib && rg -n \"N-02|N-03|N-04|N-VAL-01|Material\" docs/plans/2026-02-27-ui-cupertino-diff.md","required_paths":["docs/plans/2026-02-27-ui-cupertino-diff.md","PLANS.md"],"depends_on":[]},{"id":"R3-T02","title":"N-02 发现页接入 iOS 大标题导航（CupertinoSliverNavigationBar）","priority":2,"prompt":"改动范围：`lib/features/discovery/views/discovery_view.dart`（必要时小范围调整 `AppCupertinoPageScaffold` 的 sliver 使用方式，但优先只改发现页）。\n\n前置对照（必须先读 legado 再动手）：\n- `../legado/app/src/main/java/io/legado/app/ui/main/explore/ExploreFragment.kt`\n- `../legado/app/src/main/java/io/legado/app/ui/main/MainActivity.kt`\n对齐点：发现页作为主 tab 根页面的交互语义、入口/动作不变；仅将导航样式迁移为 iOS 大标题折叠语义。\n\n实施口径（迁移级同义）：\n1) 将发现页从普通 `CupertinoNavigationBar` 路径切到 `AppCupertinoPageScaffold(useSliverNavigationBar: true, sliverScrollController: ...)`。\n2) 重构页面滚动结构为“单一主滚动容器”驱动标题折叠：\n- 顶部搜索与统计区用 `SliverToBoxAdapter`。\n- 列表用 `SliverList/SliverPadding`，避免 `CustomScrollView` + 内层 `ListView` 的双滚动。\n- 空态/无结果态用 `SliverFillRemaining`，布局与现有语义一致。\n3) 保持现有行为不变：\n- `compressSignal` 触发时仍能回顶/收起展开（`_scrollController.animateTo(0, ...)` 对齐到新的主滚动 controller）。\n- 分组筛选 action sheet、书源展开/收起、二级页面导航、错误弹窗等行为不变。\n4) 验收按台账 `N-AC-01~03`：大标题折叠稳定、滚动无闪烁、根页不应被侧滑返回 pop；二级页侧滑返回仍可用。\n\n验证方式：\n- 通过现有编译类测试：`test/discovery_view_compile_test.dart`。\n- 代码侧验证：该页出现 `useSliverNavigationBar: true` 且列表不再创建独立 `ListView` 作为主滚动。","verify_cmd":"cd /home/server/soupreader && flutter test test/discovery_view_compile_test.dart && rg -n \"useSliverNavigationBar:\\s*true\" lib/features/discovery/views/discovery_view.dart","required_paths":["lib/features/discovery/views/discovery_view.dart"],"depends_on":["R3-T01"]},{"id":"R3-T03","title":"N-03 订阅页接入 iOS 大标题导航（CupertinoSliverNavigationBar）","priority":3,"prompt":"改动范围：`lib/features/rss/views/rss_subscription_view.dart`（必要时仅做局部辅助组件抽取，但避免扩展功能）。\n\n前置对照（必须先读 legado 再动手）：\n- `../legado/app/src/main/java/io/legado/app/ui/main/rss/RssFragment.kt`\n- `../legado/app/src/main/java/io/legado/app/ui/main/MainActivity.kt`\n对齐点：订阅页作为主 tab 根页面入口与动作语义不变（收藏/分组/设置/管理/长按菜单等）；仅迁移导航外观与折叠行为。\n\n实施口径：\n1) 将订阅页改为 `AppCupertinoPageScaffold(useSliverNavigationBar: true, sliverScrollController: ...)`。\n2) 将 `Column + Expanded(ListView)` 重构为 sliver 结构，确保大标题由主滚动驱动：\n- 搜索框/统计行/规则订阅入口使用 `SliverToBoxAdapter`。\n- 列表项使用 `SliverList`（或 `SliverList.separated` 等价实现），避免内层 `ListView` 作为主滚动。\n- 空态/无匹配时用 `SliverFillRemaining`，布局语义保持一致。\n3) 保持现有回调与交互：搜索筛选即时更新；长按菜单/跳转页/打开管理页等不变。\n4) 验收按 `N-AC-01~03`（同台账）。\n\n验证方式：\n- 跑现有测试：`test/rss_subscription_view_compile_test.dart`、`test/rss_subscription_view_group_menu_test.dart`（覆盖菜单/弹层）。\n- `rg` 确认该页已启用 `useSliverNavigationBar: true`。","verify_cmd":"cd /home/server/soupreader && flutter test test/rss_subscription_view_compile_test.dart test/rss_subscription_view_group_menu_test.dart && rg -n \"useSliverNavigationBar:\\s*true\" lib/features/rss/views/rss_subscription_view.dart","required_paths":["lib/features/rss/views/rss_subscription_view.dart"],"depends_on":["R3-T01"]},{"id":"R3-T04","title":"N-04 我的页接入 iOS 大标题导航（CupertinoSliverNavigationBar）","priority":4,"prompt":"改动范围：`lib/features/settings/views/settings_view.dart`。\n\n前置对照（必须先读 legado 再动手）：\n- `../legado/app/src/main/java/io/legado/app/ui/main/my/MyFragment.kt`\n- `../legado/app/src/main/java/io/legado/app/ui/main/MainActivity.kt`\n对齐点：我的页菜单入口顺序、key、文案、交互语义保持既有迁移结果；仅将导航样式迁移为 iOS 大标题折叠。\n\n实施口径：\n1) 将我的页从 `AppCupertinoPageScaffold` 普通模式切到 `useSliverNavigationBar: true`。\n2) 将现有 `ListView(children: [...])` 重构为 sliver（例如 `SliverList` + `SliverPadding`），避免“外层 sliver + 内层 ListView”的双滚动。\n3) 保持现有行为不变：帮助按钮、各入口 push、Web服务占位弹窗、退出等。\n4) 验收按 `N-AC-01~03`：\n- 大标题首帧展示/上滑折叠/回顶展开。\n- 根页右滑返回不得触发 pop；进入二级页后仍支持侧滑返回。\n\n验证方式：\n- 运行 `test/widget_test.dart` 中的启动用例（确保主 tab 与根页构建无回归）。\n- `rg` 确认本页启用 `useSliverNavigationBar: true`。","verify_cmd":"cd /home/server/soupreader && flutter test test/widget_test.dart -n \"App launches correctly\" && rg -n \"useSliverNavigationBar:\\s*true\" lib/features/settings/views/settings_view.dart","required_paths":["lib/features/settings/views/settings_view.dart"],"depends_on":["R3-T01"]},{"id":"R3-T05","title":"清理 lib/ 残留 Material 导入（保持行为不变）","priority":5,"prompt":"改动范围（限定）：仅清理以下文件中的 `package:flutter/material.dart` 依赖，不做 UI 行为改造：\n- `lib/features/settings/views/app_help_dialog.dart`\n- `lib/features/settings/views/about_settings_view.dart`\n- `lib/features/reader/views/reader_dict_lookup_sheet.dart`\n- `lib/features/reader/widgets/scroll_segment_paint_view.dart`\n- `lib/features/source/views/source_list_view.dart`\n\n实施口径：\n1) `SelectableText` 改为从 `package:flutter/widgets.dart` 引入（或等价不引入 Material），UI 视觉与交互不变。\n2) `ReorderableListView` / `ReorderableDragStartListener` 若可从 `flutter/widgets.dart` 导入则替换导入来源，避免 Material；保持拖拽排序行为不变。\n3) `ScrollSegmentPaintView` 仅为绘制/排版能力，改用 `widgets/rendering` 等非 Material 导出，保持绘制结果一致。\n4) 若遇到确实无 Cupertino/Widgets 等价导出能力：按 AGENTS 1.1.2 记录 `blocked`（原因/影响/替代/回补），不得“硬保留 Material”而宣称清退完成。\n\n验证方式：\n- `rg -n \"package:flutter/material\\\\.dart\" lib` 命中数显著下降，目标为这些文件不再依赖 Material。\n- 跑与改动相关的现有测试（优先 compile/基础 widget 用例），不新增/改造测试文件。","verify_cmd":"cd /home/server/soupreader && rg -n \"package:flutter/material\\\\.dart\" lib && flutter test test/widget_test.dart -n \"App launches correctly\"","required_paths":["lib/features/settings/views/app_help_dialog.dart","lib/features/settings/views/about_settings_view.dart","lib/features/reader/views/reader_dict_lookup_sheet.dart","lib/features/reader/widgets/scroll_segment_paint_view.dart","lib/features/source/views/source_list_view.dart"],"depends_on":["R3-T01"]},{"id":"R3-T06","title":"N-VAL-01 回归证据回填（含排版布局一致性）","priority":6,"prompt":"改动范围：回填 `docs/plans/2026-02-27-ui-cupertino-diff.md` 的 `N-VAL-01`（或在 `docs/plans/` 新增一份仅用于证据的回归记录文档，并在台账中链接）。\n\n预期行为：\n1) 在 `N-01~N-04` 全部接入大标题导航后，逐页回填以下证据（必须包含“排版布局一致性”结论）：\n- `N-AC-01` 标题折叠（首帧 large / 上滑 inline / 回顶恢复）。\n- `N-AC-02` 滚动稳定性（无闪烁/抖动/错位；reselect/compress 回顶联动）。\n- `N-AC-03` 返回手势（根页不 pop；二级页侧滑返回可用）。\n- 排版布局一致性：信息层级、间距、对齐、热区与 legado 语义同义（平台差异除外）。\n2) 若某页无法等价：按 AGENTS 1.1.2 追加例外记录并标注 `blocked`，同时给出替代方案与回补计划。\n\n验证方式：\n- 台账中 `N-VAL-01` 不再为 `blocked`（或明确标注阻塞原因与四要素）。\n- 文档中能检索到每页的回归条目与结论。","verify_cmd":"cd /home/server/soupreader && rg -n \"N-VAL-01|N-AC-01|N-AC-02|N-AC-03|排版布局一致性\" docs/plans/2026-02-27-ui-cupertino-diff.md","required_paths":["docs/plans/2026-02-27-ui-cupertino-diff.md"],"depends_on":["R3-T02","R3-T03","R3-T04"]}],"notes":["本轮任务严格按 AGENTS 迁移级流程：先差异清单（R3-T01），再并行实施核心页（R3-T02~R3-T04），最后清理 Material 残留（R3-T05）并回填回归证据（R3-T06）。","禁止新增/改造测试用例（AGENTS 3）；验证优先使用现有 compile/widget 测试与 `rg` 定向校验，避免使用 `flutter analyze`（除非最终提交前验收轮）。","Rss/Discovery/Settings 三页的大标题接入必须采用单一主滚动容器驱动折叠，避免内外双滚动导致标题折叠不同步或抖动。"]}